name: extract-whole-vm
on:
  workflow_dispatch:

jobs:
  dump:
    runs-on: macos-14
    timeout-minutes: 15               # job hard limit

    steps:
    # 0ï¸âƒ£ Repo checkout
    - uses: actions/checkout@v4

    # 1ï¸âƒ£ Binary ready
    - name: Prepare binary
      run: |
        chmod +x ci/ExportedFile
        xattr -d com.apple.quarantine ci/ExportedFile || true

    # 2ï¸âƒ£ Timestamp marker â€” **must precede** the extractor
    - name: Set start marker
      run: |
        echo "ğŸ“Œ Marker at $(date -u)"
        touch /tmp/started.marker

    # 3ï¸âƒ£ Run extractor, feed â forever, stop at 5Â min
    - name: Run extractor (maxÂ 5Â min)
      timeout-minutes: 5
      continue-on-error: true
      run: |
        echo "ğŸš€ Launching ExportedFile"
        yes "" | ./ci/ExportedFile || true

    # 4ï¸âƒ£ Find + tar every file newer than the marker **anywhere on the VM**
    - name: Collect new/modified files (full FS)
      if: always()
      run: |
        echo "ğŸ“¦ Archiving files newer than marker ..."
        sudo find / -type f -newer /tmp/started.marker -print0 2>/dev/null \
          | sudo gtar --null -T - -czf new-files.tgz     # GNU tar handles -T - with NULs :contentReference[oaicite:1]{index=1}

    # 5ï¸âƒ£ Upload the archive even if earlier step timed out/killed
    - name: Upload artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: new-files
        path: new-files.tgz
        retention-days: 7           # adjust 1Â â€“Â 90
